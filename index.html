<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ - Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ø·ÙŠÙ Ø¨Ù„ÙƒØ§Ù†ÙŠ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #f4f7f6; text-align: center; padding: 20px; color: #333; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: inline-block; width: 95%; max-width: 800px; position: relative; }
        h2 { color: #2c3e50; margin-bottom: 25px; border-bottom: 3px solid #3498db; display: inline-block; padding-bottom: 10px; }
        .admin-btn { position: absolute; top: 20px; left: 20px; background: #95a5a6; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 12px; }
        .admin-btn:hover { background: #7f8c8d; }
        .upload-section { border: 2px dashed #3498db; padding: 20px; margin-bottom: 20px; border-radius: 10px; background: #f0f9ff; }
        .password-section { margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 10px; }
        input[type="text"], input[type="password"] { padding: 15px; width: 70%; border: 1px solid #ddd; border-radius: 10px; font-size: 18px; text-align: center; margin-top: 10px; }
        input[type="file"] { padding: 10px; margin-top: 10px; }
        button { padding: 15px 30px; background: #3498db; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 16px; margin-top: 15px; transition: background 0.3s; }
        button:hover { background: #2980b9; }
        .btn-secondary { background: #95a5a6; }
        .btn-secondary:hover { background: #7f8c8d; }
        .btn-danger { background: #e74c3c; }
        .btn-danger:hover { background: #c0392b; }
        table { width: 100%; border-collapse: collapse; margin-top: 25px; border-radius: 10px; overflow: hidden; }
        th, td { border: 1px solid #edf2f7; padding: 15px; text-align: center; }
        th { background-color: #3498db; color: white; }
        .result-header { margin-top: 20px; padding: 15px; background: #e1effe; border-radius: 10px; color: #1e429f; font-weight: bold; font-size: 1.4em; }
        .total-row { background-color: #f9fafb; font-size: 1.5em; font-weight: bold; color: #d35400; border-top: 3px solid #3498db; }
        .advice-box { margin-top: 20px; padding: 20px; border-radius: 12px; text-align: right; line-height: 1.8; font-size: 1.1em; }
        .excellent { background-color: #def7ec; color: #03543f; border: 1px solid #84e1bc; }
        .average { background-color: #fdf6b2; color: #723b13; border: 1px solid #fce96a; }
        .low { background-color: #fde8e8; color: #9b1c1c; border: 1px solid #f8b4b4; }
        .footer { margin-top: 40px; font-size: 0.95em; color: #555; border-top: 2px solid #eee; padding-top: 20px; font-weight: 500; }
        .hidden { display: none !important; }
        .loading { color: #3498db; font-weight: bold; margin: 20px 0; }
        .success { color: #27ae60; font-weight: bold; margin: 15px 0; padding: 15px; background: #d4edda; border-radius: 10px; }
        .error { color: #e74c3c; font-weight: bold; margin: 15px 0; padding: 15px; background: #f8d7da; border-radius: 10px; }
        .info { color: #0066cc; background: #e7f3ff; padding: 15px; border-radius: 10px; margin: 15px 0; }
    </style>
</head>
<body>

<div class="card">
    <button class="admin-btn" onclick="toggleAdmin()">ğŸ”§ Ø¥Ø¯Ø§Ø±Ø©</button>
    
    <h2 id="title">Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</h2>
    
    <div id="adminPanel" class="hidden">
        <div class="password-section">
            <p><b>ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:</b></p>
            <input type="password" id="adminPassword" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±...">
            <br>
            <button onclick="verifyAdmin()">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>
    
    <div id="uploadArea" class="upload-section hidden">
        <p><b>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø£Ø³ØªØ§Ø° Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ø·ÙŠÙ!</b></p>
        <p>Ø§Ø±ÙØ¹ Ù…Ù„Ù NOTE G2-2.xlsx Ø§Ù„Ù…Ø­Ø¯Ø«</p>
        <input type="file" id="excelFile" accept=".xlsx, .xls">
        <div id="uploadStatus"></div>
        <br>
        <button class="btn-danger" onclick="clearDatabase()" style="margin-top: 20px;">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <button class="btn-secondary" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
    </div>

    <div id="searchBox" class="hidden">
        <p>Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ Ù„Ù„Ù…ØªØ¹Ù„Ù… (Ù…Ø«Ù„Ø§Ù‹: G123456789)</p>
        <input type="text" id="studentID" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ù‡Ù†Ø§..." onkeypress="if(event.key==='Enter') searchStudent()">
        <br>
        <button onclick="searchStudent()">Ø¹Ø±Ø¶ ÙƒØ´Ù Ø§Ù„Ù†Ù‚Ø§Ø·</button>
    </div>

    <div id="output"></div>

    <div class="footer">
        Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© - Ø§Ù„Ø£Ø³ØªØ§Ø°: Ø¹Ø¨Ø¯ Ø§Ù„Ù„Ø·ÙŠÙ Ø¨Ù„ÙƒØ§Ù†ÙŠ Â© 2025
    </div>
</div>

<script>
    const ADMIN_PASSWORD = "belgani2025";
    const DB_KEY = "belgani_students_data";
    let isAdmin = false;
    let storageAvailable = false;

    // ÙØ­Øµ ØªÙˆÙØ± Ø§Ù„ØªØ®Ø²ÙŠÙ†
    async function checkStorage() {
        try {
            if (typeof window.storage !== 'undefined') {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ù…Ù„ÙŠØ© Ø§Ø®ØªØ¨Ø§Ø±ÙŠØ©
                await window.storage.set('test_key', 'test', true);
                await window.storage.delete('test_key', true);
                storageAvailable = true;
                return true;
            }
        } catch (error) {
            console.log("Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¯Ø§Ø¦Ù… ØºÙŠØ± Ù…ØªØ§Ø­:", error);
        }
        storageAvailable = false;
        return false;
    }

    async function loadDatabase() {
        if (!storageAvailable) {
            return null;
        }
        try {
            const result = await window.storage.get(DB_KEY, true);
            if (result && result.value) {
                return JSON.parse(result.value);
            }
        } catch (error) {
            console.log("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©");
        }
        return null;
    }

    async function saveDatabase(data) {
        if (!storageAvailable) {
            return false;
        }
        try {
            const result = await window.storage.set(DB_KEY, JSON.stringify(data), true);
            return result !== null;
        } catch (error) {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
            return false;
        }
    }

    window.onload = async function() {
        await checkStorage();
        
        if (storageAvailable) {
            const data = await loadDatabase();
            if (data && Object.keys(data).length > 0) {
                document.getElementById('searchBox').classList.remove('hidden');
                document.getElementById('output').innerHTML = '<p class="info">âœ¨ Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ø¯Ø®Ù„ Ø±Ù…Ø²Ùƒ Ø§Ù„Ø³Ø±ÙŠ Ù„Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ù†ØªØ§Ø¦Ø¬Ùƒ</p>';
            } else {
                document.getElementById('output').innerHTML = '<p class="loading">âš ï¸ Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¨Ø¹Ø¯. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø£Ø³ØªØ§Ø°.</p>';
            }
        } else {
            document.getElementById('output').innerHTML = '<p class="error">âš ï¸ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¯Ø§Ø¦Ù… ØºÙŠØ± Ù…ØªØ§Ø­ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ¦Ø©. Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª.</p>';
            document.getElementById('searchBox').classList.remove('hidden');
        }
    };

    function toggleAdmin() {
        const panel = document.getElementById('adminPanel');
        panel.classList.toggle('hidden');
        document.getElementById('adminPassword').value = '';
    }

    function verifyAdmin() {
        const password = document.getElementById('adminPassword').value;
        if (password === ADMIN_PASSWORD) {
            isAdmin = true;
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('uploadArea').classList.remove('hidden');
            document.getElementById('searchBox').classList.add('hidden');
            
            if (!storageAvailable) {
                document.getElementById('uploadStatus').innerHTML = '<p class="error">âš ï¸ ØªØ­Ø°ÙŠØ±: Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¯Ø§Ø¦Ù… ØºÙŠØ± Ù…ØªØ§Ø­. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³ØªÙØ­ÙØ¸ Ù…Ø¤Ù‚ØªØ§Ù‹ ÙÙ‚Ø·.</p>';
            }
        } else {
            alert("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!");
        }
    }

    function logout() {
        isAdmin = false;
        document.getElementById('uploadArea').classList.add('hidden');
        document.getElementById('searchBox').classList.remove('hidden');
        document.getElementById('uploadStatus').innerHTML = '';
    }

    document.getElementById('excelFile').addEventListener('change', function(e) {
        const statusDiv = document.getElementById('uploadStatus');
        statusDiv.innerHTML = '<p class="loading">â³ Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù...</p>';
        
        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const range = XLSX.utils.sheet_to_json(sheet, {header: 1, raw: true, defval: ""});
                processData(range);
            } catch (error) {
                statusDiv.innerHTML = '<p class="error">âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù! ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ù„Ù.</p>';
                console.error(error);
            }
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    });

    async function processData(data) {
        const statusDiv = document.getElementById('uploadStatus');
        const startCol = 4;
        const endCol = 73;
        let tempDB = {};
        let studentCount = 0;

        try {
            for (let c = startCol; c <= endCol; c++) {
                let id = data[7] ? String(data[7][c]).trim().toUpperCase() : "";
                let name = data[10] ? String(data[10][c]).trim() : "";

                if (id && id !== "" && id !== "UNDEFINED") {
                    let studentGrades = [];
                    for (let r = 11; r <= 24; r++) {
                        let subjectName = data[r][3] || "Ù…Ø§Ø¯Ø©";
                        let score = data[r][c];
                        
                        let finalScore = (score !== "" && score !== undefined && score !== null) ? String(score).replace(',', '.') : "--";
                        
                        studentGrades.push({ subject: subjectName, score: finalScore });
                    }
                    
                    let rawAvg = data[25][c];
                    let finalAvg = (rawAvg !== "" && rawAvg !== undefined) ? parseFloat(String(rawAvg).replace(',', '.')) : NaN;
                    let formattedAvg = isNaN(finalAvg) ? "--" : finalAvg.toFixed(2);

                    tempDB[id] = { name: name, grades: studentGrades, average: formattedAvg };
                    studentCount++;
                }
            }

            if (studentCount === 0) {
                statusDiv.innerHTML = '<p class="error">âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø§Ø¨ ÙÙŠ Ø§Ù„Ù…Ù„Ù!</p>';
                return;
            }

            const saved = await saveDatabase(tempDB);
            if (saved || !storageAvailable) {
                statusDiv.innerHTML = `<p class="success">âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!<br>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨: ${studentCount}</p>`;
                
                if (!storageAvailable) {
                    statusDiv.innerHTML += '<p class="error">âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø¤Ù‚ØªØ§Ù‹ ÙÙ‚Ø· (Ø³ØªÙØ­Ø°Ù Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©)</p>';
                }
            } else {
                statusDiv.innerHTML = '<p class="error">âŒ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¯Ø§Ø¦Ù…!</p>';
            }
        } catch (error) {
            statusDiv.innerHTML = '<p class="error">âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!</p>';
            console.error(error);
        }
    }

    async function clearDatabase() {
        if (confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")) {
            try {
                if (storageAvailable) {
                    await window.storage.delete(DB_KEY, true);
                }
                alert("âœ… ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
                location.reload();
            } catch (error) {
                alert("âŒ ÙØ´Ù„ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");
                console.error(error);
            }
        }
    }

    function getAdvice(avg) {
        let score = parseFloat(avg);
        if (isNaN(score)) return null;
        if (score >= 8.5) return { class: 'excellent', text: '<b>ØªÙˆØ¬ÙŠÙ‡ ØªØ±Ø¨ÙˆÙŠ:</b> Ù…Ù…ØªÙ€Ø§Ø²! Ù„Ù‚Ø¯ Ø£Ø«Ø¨ØªØª Ø¬Ø¯Ø§Ø±ØªÙƒ Ø¨ØªÙÙˆÙ‚Ùƒ Ø§Ù„ÙˆØ§Ø¶Ø­. Ø§Ø³ØªÙ…Ø± ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø±.' };
        if (score >= 6.5) return { class: 'average', text: '<b>ØªÙˆØ¬ÙŠÙ‡ ØªØ±Ø¨ÙˆÙŠ:</b> Ø¹Ù…Ù„ Ø¬ÙŠØ¯. Ù†ØªÙŠØ¬ØªÙƒ Ù…Ø±Ø¶ÙŠØ©ØŒ ÙˆÙ†Ù†ØªØ¸Ø± Ù…Ù†Ùƒ Ø§Ù„Ø£ÙØ¶Ù„ ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.' };
        return { class: 'low', text: '<b>Ù†ØµÙŠØ­Ø© ØªØ±Ø¨ÙˆÙŠØ©:</b> Ù„Ø§ ØªÙ‚Ù„Ù‚ØŒ Ù‡Ø°Ù‡ Ù…Ø¬Ø±Ø¯ Ø¨Ø¯Ø§ÙŠØ©. Ø¶Ø§Ø¹Ù Ù…Ø¬Ù‡ÙˆØ¯Ùƒ ÙˆØ³ØªØªØ­Ø³Ù† Ù†ØªØ§Ø¦Ø¬Ùƒ Ø­ØªÙ…Ø§Ù‹ Ø¨Ø§Ù„Ø§Ø¬ØªÙ‡Ø§Ø¯.' };
    }

    async function searchStudent() {
        const idInput = document.getElementById('studentID').value.trim().toUpperCase();
        const output = document.getElementById('output');
        
        if (!idInput) {
            output.innerHTML = '<p class="error">âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ!</p>';
            return;
        }

        output.innerHTML = '<p class="loading">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</p>';
        
        const database = await loadDatabase();
        
        if (!database || Object.keys(database).length === 0) {
            output.innerHTML = '<p class="error">âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹! ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø£Ø³ØªØ§Ø°.</p>';
            return;
        }

        const student = database[idInput];

        if (student) {
            let advice = getAdvice(student.average);
            let html = `<div class="result-header">Ø§Ù„Ù…ØªØ¹Ù„Ù…(Ø©): ${student.name}</div>`;
            html += `<table><tr><th>Ø§Ù„Ù…Ø§Ø¯Ø© / Ø§Ù„Ù…ÙƒÙˆÙ†</th><th>Ø§Ù„Ù†Ù‚Ø·Ø©</th></tr>`;
            student.grades.forEach(item => {
                html += `<tr><td>${item.subject}</td><td><b>${item.score}</b></td></tr>`;
            });
            html += `<tr class="total-row"><td>Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©</td><td>${student.average}</td></tr></table>`;
            if (advice) html += `<div class="advice-box ${advice.class}">${advice.text}</div>`;
            output.innerHTML = html;
        } else {
            output.innerHTML = `<p class="error">âŒ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.<br>ØªØ£ÙƒØ¯ Ù…Ù† ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±Ù…Ø² Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.</p>`;
        }
    }
</script>

</body>
</html>
